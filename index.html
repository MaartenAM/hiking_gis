<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiking WebGIS - LAW & Wandelroutes</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Font Awesome voor iconen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1e5738;
            --secondary-green: #2d6847;
            --accent-green: #4a8061;
            --light-green: #6da583;
            --orange: #ff7b54;
            --orange-hover: #e66a47;
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-elevated: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-subtle: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            font-feature-settings: 'cv11', 'ss01';
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px 24px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
        }

        .sidebar-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .sidebar-tabs {
            display: flex;
            background: var(--surface-elevated);
            border-bottom: 1px solid var(--border);
            padding: 0 4px;
        }

        .tab-button {
            flex: 1;
            padding: 16px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
            margin: 4px 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: var(--surface);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--primary-green);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .tab-panel {
            display: none;
            padding: 24px;
        }

        .tab-panel.active {
            display: block;
        }

        .control-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.015em;
        }

        .section-title i {
            color: var(--accent-green);
            font-size: 16px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .input-field, .select-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgb(77 128 97 / 0.1);
        }

        .button-primary {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            background: var(--orange);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }

        .button-primary:hover {
            background: var(--orange-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .button-primary.active {
            background: var(--primary-green);
            box-shadow: var(--shadow-sm);
        }

        .button-secondary {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .button-secondary:hover {
            background: var(--surface-elevated);
            border-color: var(--accent-green);
        }

        .layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .layer-card {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .layer-card:hover {
            border-color: var(--accent-green);
            box-shadow: var(--shadow-sm);
        }

        .layer-card.active {
            border-color: var(--primary-green);
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .layer-card i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
            opacity: 0.8;
        }

        .layer-card.active i {
            opacity: 1;
        }

        .layer-name {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .filter-row .select-field {
            flex: 1;
        }

        .distance-display {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
            padding: 20px;
            border-radius: var(--radius-xl);
            text-align: center;
            margin-top: 16px;
            box-shadow: var(--shadow-md);
        }

        .distance-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }

        .distance-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .legend {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 24px;
            border: 1px solid var(--border-subtle);
        }

        .legend-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 24px;
            height: 4px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        #map {
            flex: 1;
            position: relative;
            background: var(--surface-elevated);
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-control-btn {
            width: 48px;
            height: 48px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-primary);
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
            backdrop-filter: blur(12px);
        }

        .map-control-btn:hover {
            background: var(--surface-elevated);
            transform: scale(1.05);
            border-color: var(--accent-green);
        }

        .map-control-btn.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .info-panel {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 320px;
            z-index: 1000;
            display: none;
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
        }

        .info-panel h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .info-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding-right: 48px;
        }

        .search-button {
            position: absolute;
            right: 2px;
            top: 2px;
            bottom: 2px;
            width: 44px;
            border: none;
            background: var(--orange);
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-button:hover {
            background: var(--orange-hover);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #10b981; }
        .status-loading { background: var(--orange); }
        .status-offline { background: #ef4444; }

        @media (max-width: 1024px) {
            .sidebar {
                width: 350px;
            }
            
            .layer-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            #map {
                height: 50vh;
            }

            .map-controls {
                top: 10px;
                right: 10px;
            }

            .info-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: var(--surface-elevated);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-mountain"></i>
                    Hiking WebGIS
                </div>
                <div class="sidebar-subtitle">LAW routes & wandelnavigatie</div>
            </div>
            
            <div class="sidebar-tabs">
                <button class="tab-button active" data-tab="layers">
                    <i class="fas fa-layers"></i>
                    Lagen
                </button>
                <button class="tab-button" data-tab="routes">
                    <i class="fas fa-route"></i>
                    Routes
                </button>
                <button class="tab-button" data-tab="tools">
                    <i class="fas fa-tools"></i>
                    Tools
                </button>
                <button class="tab-button" data-tab="search">
                    <i class="fas fa-search"></i>
                    Zoeken
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Lagen Tab -->
                <div class="tab-panel active" id="layers-panel">
                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-map"></i>
                            Basiskaarten
                        </div>
                        <div class="layer-grid">
                            <div class="layer-card active" data-layer="osm">
                                <i class="fas fa-map-marked-alt"></i>
                                <div class="layer-name">OpenStreetMap</div>
                            </div>
                            <div class="layer-card" data-layer="topo">
                                <i class="fas fa-mountain"></i>
                                <div class="layer-name">Topografisch</div>
                            </div>
                            <div class="layer-card" data-layer="satellite">
                                <i class="fas fa-satellite"></i>
                                <div class="layer-name">Satelliet</div>
                            </div>
                            <div class="layer-card" data-layer="terrain">
                                <i class="fas fa-globe-europe"></i>
                                <div class="layer-name">Terrein</div>
                            </div>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-hiking"></i>
                            Wandellagen
                        </div>
                        <div class="layer-grid">
                            <div class="layer-card active" data-overlay="law">
                                <i class="fas fa-route"></i>
                                <div class="layer-name">LAW Paden</div>
                            </div>
                            <div class="layer-card" data-overlay="local">
                                <i class="fas fa-walking"></i>
                                <div class="layer-name">Lokale routes</div>
                            </div>
                        </div>
                    </div>

                    <div class="legend">
                        <div class="legend-title">
                            <i class="fas fa-list"></i>
                            Legenda
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>LAW Paden (PDOK)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>Lokale routes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #7c3aed;"></div>
                            <span>Meetlijn</span>
                        </div>
                    </div>
                </div>

                <!-- Routes Tab -->
                <div class="tab-panel" id="routes-panel">
                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-filter"></i>
                            LAW Route Filters
                        </div>
                        <div class="filter-row">
                            <select id="lawLayerFilter" class="select-field">
                                <option value="">Alle LAW types</option>
                                <option value="landelijke-wandelroutes">Landelijke Wandelroutes</option>
                                <option value="streekpaden">Streekpaden</option>
                                <option value="ns-wandelingen">NS-wandelingen</option>
                                <option value="ov-stappers">OV-stappers</option>
                                <option value="stad-te-voet">Stad te voet</option>
                            </select>
                        </div>
                        <button class="button-primary" onclick="applyLAWFilters()">
                            <i class="fas fa-filter"></i>
                            LAW Filter toepassen
                        </button>
                        <button class="button-secondary" onclick="clearLAWFilters()">
                            <i class="fas fa-times"></i>
                            Alle LAW lagen tonen
                        </button>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-download"></i>
                            Route Export
                        </div>
                        <button class="button-secondary" onclick="exportRoutes('gpx')">
                            <i class="fas fa-file-export"></i>
                            Exporteer als GPX
                        </button>
                        <button class="button-secondary" onclick="exportRoutes('kml')">
                            <i class="fas fa-file-code"></i>
                            Exporteer als KML
                        </button>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Route Status
                        </div>
                        <div class="legend-item">
                            <div class="status-indicator status-online"></div>
                            <span>LAW routes geladen</span>
                        </div>
                        <div class="legend-item">
                            <div class="status-indicator status-loading"></div>
                            <span>Waymarked trails laden...</span>
                        </div>
                        <div class="legend-item">
                            <div class="status-indicator status-online"></div>
                            <span>PDOK service beschikbaar</span>
                        </div>
                    </div>
                </div>

                <!-- Tools Tab -->
                <div class="tab-panel" id="tools-panel">
                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-ruler"></i>
                            Afstand meten
                        </div>
                        <button id="measureBtn" class="button-primary" onclick="toggleMeasure()">
                            <i class="fas fa-ruler-combined"></i>
                            Start meting
                        </button>
                        <button class="button-secondary" onclick="clearMeasurements()">
                            <i class="fas fa-trash"></i>
                            Wis metingen
                        </button>
                        <div id="distanceDisplay" class="distance-display">
                            <div class="distance-value">0.00</div>
                            <div class="distance-label">Kilometer</div>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-map-pin"></i>
                            Navigatie Tools
                        </div>
                        <button class="button-secondary" onclick="zoomToNetherlands()">
                            <i class="fas fa-home"></i>
                            Zoom naar Nederland
                        </button>
                        <button class="button-secondary" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i>
                            Mijn locatie
                        </button>
                        <div id="waypointsList" style="margin-top: 16px;">
                            <!-- Waypoints lijst wordt hier dynamisch toegevoegd -->
                        </div>
                    </div>
                </div>

                <!-- Zoeken Tab -->
                <div class="tab-panel" id="search-panel">
                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-search"></i>
                            Locatie zoeken
                        </div>
                        <div class="control-group">
                            <label class="control-label">Zoek naar plaats, adres of route</label>
                            <div class="search-container">
                                <input type="text" id="searchInput" class="input-field search-input" 
                                       placeholder="Bijv. Amsterdam, LAW1, of Pieterpad...">
                                <button class="search-button" onclick="searchLocation()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="loading-spinner" id="searchSpinner"></div>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-history"></i>
                            Recente zoekopdrachten
                        </div>
                        <div id="searchHistory">
                            <!-- Zoekgeschiedenis wordt hier dynamisch toegevoegd -->
                            <div class="legend-item" style="font-style: italic; color: var(--text-muted);">
                                Nog geen zoekopdrachten
                            </div>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="section-title">
                            <i class="fas fa-bookmark"></i>
                            Favorieten
                        </div>
                        <button class="button-secondary" onclick="addCurrentViewToFavorites()">
                            <i class="fas fa-plus"></i>
                            Huidige weergave opslaan
                        </button>
                        <div id="favoritesList" style="margin-top: 16px;">
                            <!-- Favorieten lijst wordt hier dynamisch toegevoegd -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <div class="map-controls">
            <div class="map-control-btn" onclick="zoomToNetherlands()" title="Zoom naar Nederland">
                <i class="fas fa-home"></i>
            </div>
            <div class="map-control-btn" onclick="getCurrentLocation()" title="Mijn locatie">
                <i class="fas fa-crosshairs"></i>
            </div>
            <div class="map-control-btn" onclick="toggleFullscreen()" title="Volledig scherm">
                <i class="fas fa-expand"></i>
            </div>
        </div>
    </div>

    <div id="infoPanel" class="info-panel">
        <h4>Route informatie</h4>
        <div id="routeInfo" class="info-content"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // Globale variabelen
        let map;
        let measuring = false;
        let measureLine;
        let measureMarkers = [];
        let totalDistance = 0;
        let lawLayer, waymarkedLayer, localTrailsLayer;
        let baseLayers = {};
        let overlayLayers = {};
        let activeBaseLayer = 'osm';
        let waypoints = [];
        let searchHistory = [];
        let favorites = [];

        // Kaart initialiseren
        function initMap() {
            // Kaart maken gecentreerd op Nederland
            map = L.map('map').setView([52.1326, 5.2913], 7);

            // Base layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });

            const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
                attribution: '© PDOK'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });

            const terrainLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });

            // Standaard OSM layer toevoegen
            osmLayer.addTo(map);

            // Base layers object
            baseLayers = {
                'osm': osmLayer,
                'topo': topoLayer,
                'satellite': satelliteLayer,
                'terrain': terrainLayer
            };

            // LAW layer van PDOK - alle LAW lagen
            lawLayer = L.layerGroup();
            
            // Voeg alle beschikbare LAW lagen toe
            const lawLayers = [
                'landelijke-wandelroutes',  // Hoofdlaag
                'streekpaden',
                'ns-wandelingen', 
                'ov-stappers',
                'stad-te-voet'
            ];
            
            lawLayers.forEach(layerName => {
                const wmsLayer = L.tileLayer.wms('https://service.pdok.nl/wandelnet/landelijke-wandelroutes/wms/v1_0', {
                    layers: layerName,
                    format: 'image/png',
                    transparent: true,
                    attribution: '© PDOK Wandelnet',
                    opacity: 0.8
                });
                lawLayer.addLayer(wmsLayer);
            });
            
            lawLayer.addTo(map);

            // Waymarked trails layer (verwijderd)
            // waymarkedLayer.addTo(map);

            // Lokale trails layer (simulatie)
            localTrailsLayer = L.layerGroup();
            addLocalTrails();

            // Overlay layers object (waymarked en cycling verwijderd)
            overlayLayers = {
                'law': lawLayer,
                'local': localTrailsLayer
            };

            // Event listeners
            setupEventListeners();
            setupTabNavigation();
            loadStoredData();
        }

        // Tab navigatie instellen
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update active button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update active panel
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    document.getElementById(targetTab + '-panel').classList.add('active');
                });
            });
        }

        // Layer kaarten event listeners
        function setupLayerCards() {
            // Base layer cards
            document.querySelectorAll('[data-layer]').forEach(card => {
                card.addEventListener('click', () => {
                    const layerType = card.dataset.layer;
                    switchBaseLayer(layerType);
                    
                    // Update UI
                    document.querySelectorAll('[data-layer]').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                });
            });

            // Overlay layer cards
            document.querySelectorAll('[data-overlay]').forEach(card => {
                card.addEventListener('click', () => {
                    const overlayType = card.dataset.overlay;
                    toggleOverlay(overlayType);
                    card.classList.toggle('active');
                });
            });
        }

        // Base layer wisselen
        function switchBaseLayer(layerType) {
            // Verwijder huidige base layer
            if (baseLayers[activeBaseLayer]) {
                map.removeLayer(baseLayers[activeBaseLayer]);
            }
            
            // Voeg nieuwe base layer toe
            if (baseLayers[layerType]) {
                baseLayers[layerType].addTo(map);
                activeBaseLayer = layerType;
            }
        }

        // Overlay toggle
        function toggleOverlay(overlayType) {
            const layer = overlayLayers[overlayType];
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            } else {
                layer.addTo(map);
            }
        }

        // Lokale trails toevoegen
        function addLocalTrails() {
            const localRoutes = [
                {
                    name: 'Boslus Veluwe',
                    coordinates: [[52.0880, 5.6673], [52.1015, 5.7234], [52.0854, 5.7891]],
                    description: 'Mooie bosroute door de Veluwe'
                },
                {
                    name: 'Duinpad Zandvoort',
                    coordinates: [[52.3676, 4.5309], [52.3584, 4.5198], [52.3421, 4.5067]],
                    description: 'Wandeling door de duinen van Zandvoort'
                },
                {
                    name: 'Kinderdijk Molens Route',
                    coordinates: [[51.8838, 4.6395], [51.8776, 4.6298], [51.8834, 4.6234]],
                    description: 'Route langs de beroemde molens van Kinderdijk'
                }
            ];

            localRoutes.forEach(route => {
                const polyline = L.polyline(route.coordinates, {
                    color: '#ea580c',
                    weight: 3,
                    opacity: 0.8
                });

                polyline.bindPopup(`
                    <div>
                        <h4 style="margin-bottom: 8px;">${route.name}</h4>
                        <p style="margin: 0; color: #64748b;">${route.description}</p>
                    </div>
                `);

                localTrailsLayer.addLayer(polyline);
            });
        }

        // Event listeners instellen
        function setupEventListeners() {
            setupLayerCards();

            // Zoek functionaliteit
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });

            // Kaart click event voor meten
            map.on('click', function(e) {
                if (measuring) {
                    addMeasurePoint(e.latlng);
                }
            });
        }

        // Meten toggle
        function toggleMeasure() {
            measuring = !measuring;
            const btn = document.getElementById('measureBtn');
            
            if (measuring) {
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop meting';
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.innerHTML = '<i class="fas fa-ruler-combined"></i> Start meting';
                btn.classList.remove('active');
                map.getContainer().style.cursor = '';
            }
        }

        // Meetpunt toevoegen
        function addMeasurePoint(latlng) {
            const marker = L.circleMarker(latlng, {
                radius: 6,
                color: '#7c3aed',
                fillColor: '#7c3aed',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);

            measureMarkers.push(marker);

            if (measureMarkers.length > 1) {
                // Zoek de vorige marker (geen lijn)
                let prevMarker = null;
                for (let i = measureMarkers.length - 2; i >= 0; i--) {
                    if (measureMarkers[i].getLatLng) {
                        prevMarker = measureMarkers[i];
                        break;
                    }
                }

                if (prevMarker) {
                    const line = L.polyline([prevMarker.getLatLng(), latlng], {
                        color: '#7c3aed',
                        weight: 3,
                        dashArray: '8, 12'
                    }).addTo(map);

                    measureMarkers.push(line);

                    // Bereken afstand
                    const distance = prevMarker.getLatLng().distanceTo(latlng) / 1000; // in km
                    totalDistance += distance;
                    updateDistanceDisplay();
                }
            }
        }

        // Distance display updaten
        function updateDistanceDisplay() {
            const displayEl = document.getElementById('distanceDisplay');
            displayEl.querySelector('.distance-value').textContent = totalDistance.toFixed(2);
        }

        // Metingen wissen
        function clearMeasurements() {
            measureMarkers.forEach(item => {
                map.removeLayer(item);
            });
            measureMarkers = [];
            totalDistance = 0;
            updateDistanceDisplay();
        }

        // LAW filters toepassen
        function applyLAWFilters() {
            const selectedLayer = document.getElementById('lawLayerFilter').value;
            
            // Verwijder huidige LAW layer
            map.removeLayer(lawLayer);
            lawLayer.clearLayers();
            
            if (selectedLayer) {
                // Voeg alleen geselecteerde laag toe
                const wmsLayer = L.tileLayer.wms('https://service.pdok.nl/wandelnet/landelijke-wandelroutes/wms/v1_0', {
                    layers: selectedLayer,
                    format: 'image/png',
                    transparent: true,
                    attribution: '© PDOK Wandelnet',
                    opacity: 0.8
                });
                lawLayer.addLayer(wmsLayer);
            } else {
                // Voeg alle lagen toe
                const lawLayers = [
                    'landelijke-wandelroutes',
                    'streekpaden',
                    'ns-wandelingen', 
                    'ov-stappers',
                    'stad-te-voet'
                ];
                
                lawLayers.forEach(layerName => {
                    const wmsLayer = L.tileLayer.wms('https://service.pdok.nl/wandelnet/landelijke-wandelroutes/wms/v1_0', {
                        layers: layerName,
                        format: 'image/png',
                        transparent: true,
                        attribution: '© PDOK Wandelnet',
                        opacity: 0.8
                    });
                    lawLayer.addLayer(wmsLayer);
                });
            }
            
            lawLayer.addTo(map);
        }

        // LAW filters wissen
        function clearLAWFilters() {
            document.getElementById('lawLayerFilter').value = '';
            applyLAWFilters(); // Dit voegt alle lagen weer toe
        }

        // Routes exporteren
        function exportRoutes(format) {
            // Simplified export functie
            alert(`Export naar ${format.toUpperCase()} wordt voorbereid...`);
            // Hier zou je de daadwerkelijke export logica implementeren
        }

        // Waypoint toevoegen
        function addWaypoint() {
            const center = map.getCenter();
            const waypoint = {
                id: Date.now(),
                lat: center.lat,
                lng: center.lng,
                name: `Waypoint ${waypoints.length + 1}`,
                description: 'Toegevoegd op ' + new Date().toLocaleString('nl-NL')
            };

            const marker = L.marker([center.lat, center.lng], {
                icon: L.divIcon({
                    className: 'waypoint-marker',
                    html: `<div style="background: #ff7b54; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${waypoints.length + 1}</div>`,
                    iconSize: [24, 24]
                })
            }).addTo(map);

            marker.bindPopup(`
                <div>
                    <h4>${waypoint.name}</h4>
                    <p>${waypoint.description}</p>
                    <button onclick="removeWaypoint(${waypoint.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Verwijderen</button>
                </div>
            `);

            waypoint.marker = marker;
            waypoints.push(waypoint);
            updateWaypointsList();
        }

        // Waypoint verwijderen
        function removeWaypoint(id) {
            const index = waypoints.findIndex(wp => wp.id === id);
            if (index !== -1) {
                map.removeLayer(waypoints[index].marker);
                waypoints.splice(index, 1);
                updateWaypointsList();
            }
        }

        // Alle waypoints wissen
        function clearWaypoints() {
            waypoints.forEach(wp => map.removeLayer(wp.marker));
            waypoints = [];
            updateWaypointsList();
        }

        // Waypoints lijst updaten
        function updateWaypointsList() {
            const container = document.getElementById('waypointsList');
            if (waypoints.length === 0) {
                container.innerHTML = '<div style="font-style: italic; color: var(--text-muted); font-size: 12px;">Geen waypoints</div>';
                return;
            }

            container.innerHTML = waypoints.map(wp => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--surface-elevated); border-radius: 6px; margin-bottom: 8px; font-size: 12px;">
                    <span>${wp.name}</span>
                    <button onclick="removeWaypoint(${wp.id})" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Hoogteprofiel tonen
        function showElevationProfile() {
            alert('Hoogteprofiel functionaliteit wordt binnenkort toegevoegd!');
        }

        // Locatie zoeken
        function searchLocation() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const spinner = document.getElementById('searchSpinner');
            spinner.style.display = 'block';

            // Voeg toe aan zoekgeschiedenis
            if (!searchHistory.includes(query)) {
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 5); // Behoud laatste 5
                updateSearchHistory();
                saveStoredData();
            }

            // Gebruik Nominatim API voor geocoding
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=nl&limit=3`)
                .then(response => response.json())
                .then(data => {
                    spinner.style.display = 'none';
                    
                    if (data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        map.setView([lat, lon], 12);
                        
                        // Voeg marker toe
                        const marker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'search-marker',
                                html: '<div style="background: #ff7b54; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="fas fa-search" style="font-size: 14px;"></i></div>',
                                iconSize: [32, 32]
                            })
                        }).addTo(map);

                        marker.bindPopup(`
                            <div>
                                <h4>Zoekresultaat</h4>
                                <p>${result.display_name}</p>
                                <button onclick="addCurrentViewToFavorites('${result.display_name}')" style="background: var(--primary-green); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px;">
                                    <i class="fas fa-star"></i> Opslaan als favoriet
                                </button>
                            </div>
                        `).openPopup();
                        
                        // Verwijder marker na 10 seconden
                        setTimeout(() => {
                            map.removeLayer(marker);
                        }, 10000);
                    } else {
                        alert('Locatie niet gevonden');
                    }
                })
                .catch(error => {
                    spinner.style.display = 'none';
                    console.error('Zoekfout:', error);
                    alert('Er is een fout opgetreden bij het zoeken');
                });
        }

        // Zoekgeschiedenis updaten
        function updateSearchHistory() {
            const container = document.getElementById('searchHistory');
            if (searchHistory.length === 0) {
                container.innerHTML = '<div style="font-style: italic; color: var(--text-muted);">Nog geen zoekopdrachten</div>';
                return;
            }

            container.innerHTML = searchHistory.map(query => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); cursor: pointer;" onclick="searchAgain('${query}')">
                    <span style="font-size: 14px;">${query}</span>
                    <i class="fas fa-redo" style="color: var(--text-muted); font-size: 12px;"></i>
                </div>
            `).join('');
        }

        // Opnieuw zoeken
        function searchAgain(query) {
            document.getElementById('searchInput').value = query;
            searchLocation();
        }

        // Huidige weergave toevoegen aan favorieten
        function addCurrentViewToFavorites(name = null) {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const favName = name || `Locatie ${favorites.length + 1}`;
            
            const favorite = {
                id: Date.now(),
                name: favName,
                lat: center.lat,
                lng: center.lng,
                zoom: zoom,
                created: new Date().toLocaleString('nl-NL')
            };

            favorites.push(favorite);
            updateFavoritesList();
            saveStoredData();
        }

        // Favorieten lijst updaten
        function updateFavoritesList() {
            const container = document.getElementById('favoritesList');
            if (favorites.length === 0) {
                container.innerHTML = '<div style="font-style: italic; color: var(--text-muted); font-size: 12px;">Nog geen favorieten</div>';
                return;
            }

            container.innerHTML = favorites.map(fav => `
                <div style="padding: 12px; background: var(--surface-elevated); border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <strong style="font-size: 14px;">${fav.name}</strong>
                        <button onclick="removeFavorite(${fav.id})" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${fav.created}</div>
                    <button onclick="goToFavorite(${fav.id})" style="background: var(--primary-green); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-map-marker-alt"></i> Ga naar locatie
                    </button>
                </div>
            `).join('');
        }

        // Ga naar favoriet
        function goToFavorite(id) {
            const favorite = favorites.find(fav => fav.id === id);
            if (favorite) {
                map.setView([favorite.lat, favorite.lng], favorite.zoom);
            }
        }

        // Favoriet verwijderen
        function removeFavorite(id) {
            const index = favorites.findIndex(fav => fav.id === id);
            if (index !== -1) {
                favorites.splice(index, 1);
                updateFavoritesList();
                saveStoredData();
            }
        }

        // Data opslaan in localStorage
        function saveStoredData() {
            const data = {
                searchHistory,
                favorites
            };
            localStorage.setItem('hikingWebGIS', JSON.stringify(data));
        }

        // Opgeslagen data laden
        function loadStoredData() {
            try {
                const stored = localStorage.getItem('hikingWebGIS');
                if (stored) {
                    const data = JSON.parse(stored);
                    
                    if (data.searchHistory) {
                        searchHistory = data.searchHistory;
                        updateSearchHistory();
                    }
                    
                    if (data.favorites) {
                        favorites = data.favorites;
                        updateFavoritesList();
                    }
                } catch (error) {
                    console.error('Fout bij laden opgeslagen data:', error);
                }
        }

        // Zoom naar Nederland
        function zoomToNetherlands() {
            map.setView([52.1326, 5.2913], 7);
        }

        // Huidige locatie ophalen
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    map.setView([lat, lon], 14);
                    
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'location-marker',
                            html: '<div style="background: #10b981; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3), 0 2px 4px rgba(0,0,0,0.2);"><div style="width: 8px; height: 8px; background: white; border-radius: 50%;"></div></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map);

                    marker.bindPopup('Uw huidige locatie').openPopup();
                    
                    // Verwijder marker na 15 seconden
                    setTimeout(() => {
                        map.removeLayer(marker);
                    }, 15000);
                }, function(error) {
                    alert('Locatie kon niet worden bepaald');
                });
            } else {
                alert('Geolocation wordt niet ondersteund door deze browser');
            }
        }

        // Volledig scherm toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Kaart initialiseren wanneer pagina geladen is
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
